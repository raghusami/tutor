<!doctype html>
<html <head>
<!-- Required meta tags -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.3/font/bootstrap-icons.css">
<title>Point Of Sales</title>
<script type="text/javascript">
    const api_url =
        "https://6297756a8d77ad6f75038023.mockapi.io/Product";

    var productDetails;
    var selectedRow = null;
    var ddlProduct;
    // Current date
    var todaydate = new Date();
    var day = todaydate.getDate();
    var month = todaydate.getMonth() + 1;
    var year = todaydate.getFullYear();
    var datestring = day + "/" + month + "/" + year;

    // Defining async function
    async function getapi(url) {
        // Storing response

        const response = await fetch(url);
        // Storing data in form of JSON
        productDetails = await response.json();
        console.log(productDetails);
        OnSuccess(productDetails);
    }

    // Calling that async function
    getapi(api_url);
    // curent date call function

    function OnSuccess(response) {

        ddlProduct = document.getElementById("txt_name");
        AddOption("SELECT PRODUCT", "0");
        for (var i in response) {

            AddOption(response[i].ProductName, response[i].ProductCode);
        }
    }
    // find the dropdown list control
    function AddOption(text, value) {

        var option = document.createElement('option');
        option.value = value;
        option.innerHTML = text;
        ddlProduct.options.add(option);
    }

    window.onload = function () {
        document.getElementById("txt_date").value = datestring;
    }
    // Get product name,code,rate from array matched product code
    function getProductDetails(a) {

        var selectedValue = (a.value || a.options[a.selectedIndex].value);  //crossbrowser solution =)
        if (selectedValue != "") {
            productDetails.forEach(element => {
                if (element.ProductCode == selectedValue) {
                    document.getElementById("txt_code").value = element.ProductCode;
                    document.getElementById("txt_rate").value = element.Rate;
                    document.getElementById("txt_qty").value = 1;
                    return;
                }

            });
        }
    }
    // Add and edit product details table
    function productRow() {
        var formData = readFormData();
        if (selectedRow == null) {
            addProduct(formData);
        }
        else {
            updateRecord(formData);
        }

    }


    // Getting data from product details like product name,code,rate,qty 
    function readFormData() {
        var formData = {};
        var productNameObject = document.getElementById("txt_name");
        formData["productName"] = productNameObject.options[productNameObject.selectedIndex].text;
        formData["productCode"] = document.getElementById("txt_code").value;
        formData["rate"] = document.getElementById("txt_rate").value;
        formData["quantity"] = document.getElementById("txt_qty").value;

        return formData;
    }
    // Add product in the table list
    function addProduct(formInputData) {

        var exits = productExist(formInputData.productCode);
        if (exits == true) {
            return;
        }

        var productDetailsTable = document.getElementById("txt_product_details").getElementsByTagName('tbody')[0];
        var newRow = productDetailsTable.insertRow(productDetailsTable.length);

        cell1 = newRow.insertCell(0);
        cell1.innerHTML = formInputData.productName;
        cell1.style.textAlign = "left";

        cell2 = newRow.insertCell(1);
        cell2.innerHTML = formInputData.productCode;
        cell2.style.textAlign = "center";

        cell3 = newRow.insertCell(2);
        cell3.innerHTML = formInputData.rate
        cell3.style.textAlign = "right";

        cell4 = newRow.insertCell(3);
        cell4.innerHTML = formInputData.quantity;
        cell4.style.textAlign = "center";

        cell5 = newRow.insertCell(4);
        cell5.innerHTML = (parseInt(formInputData.quantity) * parseInt(formInputData.rate));
        cell5.style.textAlign = "right";

        cell6 = newRow.insertCell(5);
        cell6.innerHTML = `<a onClick="onEdit(this)"  class="btn btn-outline-danger btn-sm"><i class="bi bi-pencil"></i></a>
                       <a onClick="onDelete(this)" class="btn btn-outline-dark btn-sm"><i class="bi bi-trash3-fill"></i></a>`;
        cell6.style.textAlign = "center";

        productAddDetailsClear();
        grossTotal();
    }
    // calculate Gross amount and GST amount 
    function grossTotal() {

        var table = document.getElementById("txt_product_details");
        var rows = table.getElementsByTagName('tr');
        var gstAmount;
        var grossTotal = 0;
        for (var i = 1; i < rows.length; i++) {
            grossTotal = grossTotal + parseInt(table.rows[i].cells[4].innerHTML);
        }
        document.getElementById("txt_grossamount").value = grossTotal;
        gstAmount = (grossTotal / 100) * 18;
        document.getElementById("txt_gst").value = gstAmount.toFixed(2);

    }
    // check already exist product in table list
    function productExist(newProductCode) {
        var table = document.getElementById("txt_product_details");
        var rows = table.getElementsByTagName('tr');
        for (var i = 1; i < rows.length; i++) {
            var productCode = table.rows[i].cells[1].innerHTML;
            if (newProductCode == productCode) {
                alertNew("This Product Already Exists !", "warning");
                productAddDetailsClear();
                return true;
            }
        }
    }
    // Bind the table selected list data in input fields
    function onEdit(event) {

        selectedRow = event.parentElement.parentElement;
        document.getElementById("txt_name").value = selectedRow.cells[1].innerHTML;
        document.getElementById("txt_code").value = selectedRow.cells[1].innerHTML;
        document.getElementById("txt_rate").value = selectedRow.cells[2].innerHTML;
        document.getElementById("txt_qty").value = selectedRow.cells[3].innerHTML;
    }
    // update product in the table list
    function updateRecord(formData) {
        selectedRow.cells[0].innerHTML = formData.productName;
        selectedRow.cells[1].innerHTML = formData.productCode;
        selectedRow.cells[2].innerHTML = formData.rate;
        selectedRow.cells[3].innerHTML = formData.quantity;
        selectedRow.cells[4].innerHTML = (parseInt(formData.quantity) * parseInt(formData.rate));
        productAddDetailsClear();
        grossTotal();
    }


    // Delete rom from table list
    function onDelete(td) {
        if (confirm('Are you sure to delete this record ?')) {
            row = td.parentElement.parentElement;
            document.getElementById("txt_product_details").deleteRow(row.rowIndex);
            grossTotal();
        }
    }
    // clear product details input fields
    function productAddDetailsClear() {
        var productNameObject = document.getElementById("txt_name").value = 0;
        document.getElementById("txt_code").value = "";
        document.getElementById("txt_rate").value = "";
        document.getElementById("txt_qty").value = "";
        selectedRow = null;

    }
    // Displying message like success,danger,warning
    function alertNew(message, type) {
        var alertPlaceholder = document.getElementById('liveAlertPlaceholder')
        var wrapper = document.createElement('div')
        wrapper.innerHTML = '<div class="alert alert-' + type + ' alert-dismissible" role="alert">' + message + '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>'
        alertPlaceholder.append(wrapper)
    }

    // save the data to database
    function formSubmit() {

        var customerName = document.getElementById("txt_customerName").value;
        var mobileNo = document.getElementById("txt_mobileno").value;
        var grossAmount = document.getElementById("txt_grossamount").value;
        var gstAmount = document.getElementById("txt_gst").value;

        var productDetails = [];

        var table = document.getElementById("txt_product_details");
        var rows = table.getElementsByTagName('tr');

        for (var i = 1; i < rows.length; i++) {
            
            var dataOject = {
                productName: table.rows[i].cells[0].innerHTML,
                productCode: table.rows[i].cells[1].innerHTML,
                rate: table.rows[i].cells[2].innerHTML,
                quantity: table.rows[i].cells[3].innerHTML,
                grossTotal: table.rows[i].cells[4].innerHTML
            }
            productDetails.push(dataOject);

        }

        var finalObject = {
            customerName: customerName,
            mobileNumber: mobileNo,
            gstAmount: gstAmount,
            grossAmount: grossAmount,
            productDetails: productDetails
        }
        console.log(finalObject);
        console.log(JSON.stringify(finalObject))

        fetch('https://6297756a8d77ad6f75038023.mockapi.io/pos', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(finalObject),
        })
            .then(response => response.json())
            .then(data => {
                var result = "Succussfully created the Bill the Bill No is " + data.id;
                alertNew(result, 'success')
                saveFromClear();
            })
            .catch((error) => {
                alertNew(error, 'danger')
                console.error('Error:', error);
            });


    }
    // form input clear 
    function saveFromClear() {
        document.getElementById("txt_customerName").value = "";
        mobileNo = document.getElementById("txt_mobileno").value = "";
        grossAmount = document.getElementById("txt_grossamount").value = "";
        gstAmount = document.getElementById("txt_gst").value = "";
        var node = document.getElementById("tbl_product_list");
        while (node.hasChildNodes()) {
            node.removeChild(node.lastChild);
        }
    }


</script>
</head>

<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark" aria-label="Ninth navbar example">
        <div class="container-xl">
            <a class="navbar-brand" href="#">POINT OF SALES (POS)</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarsExample07XL"
                aria-controls="navbarsExample07XL" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarsExample07XL">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link" aria-current="page" href="pos.html">Billing Entry</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="sales.html">Billing List</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="product.html">Product</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="dropdown07XL" data-bs-toggle="dropdown"
                            aria-expanded="false">Dropdown</a>
                        <ul class="dropdown-menu" aria-labelledby="dropdown07XL">
                            <li><a class="dropdown-item" href="#">Action</a></li>
                            <li><a class="dropdown-item" href="#">Another action</a></li>
                            <li><a class="dropdown-item" href="#">Something else here</a></li>
                        </ul>
                    </li>
                </ul>
                <form>
                    <input class="form-control" type="text" placeholder="Search" aria-label="Search">
                </form>
            </div>
        </div>
    </nav>
    <div class="container mt-3">
        <h5 class="text-left"><i class="bi bi-file-earmark-post"></i>Billing Entry</h1>
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div id="liveAlertPlaceholder"></div>
                </div>
            </div>
            <div class=" row justify-content-end">
                <div class=" col-md-4">
                    <div class="form-group row">
                        <label for="txt_Date" class="col-sm-5 col-form-label"><i class="bi bi-calendar-week"></i>
                            Date</label>
                        <div class="col-sm-7">
                            <input type="text" class="form-control form-control-sm" id="txt_date">
                        </div>
                    </div>
                </div>
            </div>
            <div class="row justify-content-end mt-3">
                <div class=" col-md-4">
                    <div class="form-group row">
                        <label for="txt_custno" class="col-sm-5 col-form-label"><i class="bi bi-person-circle"></i>
                            Customer Name </label>
                        <div class="col-sm-7">
                            <input type="text" class="form-control form-control-sm" id="txt_customerName">
                        </div>
                    </div>
                </div>
            </div>
            <div class="row justify-content-end mt-3">
                <div class="col-md-4">
                    <div class="form-group row">
                        <label for="txt_mobileno" class="col-sm-5 col-form-label"><i class="bi bi-phone-fill"></i>
                            Mobile Number</label>
                        <div class="col-sm-7">
                            <input type="text" class="form-control form-control-sm" id="txt_mobileno">
                        </div>
                    </div>
                </div>
            </div>
            <hr>
            <div class="row mt-3">
                <div class="col-md-12">
                    <table class="table table-bordered table-sm" id="txt_product_table">
                        <thead class=" text-center bg-dark text-white">
                            <th>Product Name</th>
                            <th>Product Code</th>
                            <th>Rate</th>
                            <th>Quantity</th>
                            <th>Add</th>
                        </thead>
                        <tbody>
                            <tr class="text-center">
                                <td><select class="form-select " aria-label="select the one"
                                        onchange="getProductDetails(this)" id="txt_name">


                                    </select>
                                </td>
                                <td><input type="text" class="form-control form-control-sm" readonly="readonly"
                                        id="txt_code"></td>

                                <td><input type="text" class="form-control form-control-sm" readonly="readonly"
                                        id="txt_rate"></td>
                                <td><input type="text" class="form-control form-control-sm" id="txt_qty"></td>
                                <td><button class="btn btn-outline-danger btn-sm" id="btn_add" onclick="productRow()"><i
                                            class="bi bi-plus-circle-fill"></i> Add </button> </td>

                            </tr>

                        </tbody>
                        </thead>
                    </table>
                </div>
            </div>
            <hr>
            <div class="row">
                <div class="col-md-12">
                    <table class="table table-bordered table-sm" id="txt_product_details">
                        <thead class="text-center bg-dark text-white">
                            <th>Product Name</th>
                            <th>Product Code</th>
                            <th>Rate</th>
                            <th>Quantity</th>
                            <th>Total</th>
                            <th></th>
                        </thead>
                        <tbody id="tbl_product_list">

                        </tbody>
                    </table>
                </div>
            </div>
            <hr>
            <div class="row justify-content-end mt-4">
                <div class="col-md-4">
                    <div class="form-group row">
                        <label for="txt_gst" class="col-sm-4 col-form-label fw-bolder"><i
                                class="bi bi-currency-dollar"></i> GST Amount</label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control form-control-sm fw-bolder" id="txt_gst">
                        </div>
                    </div>

                </div>
                <div class="col-md-4">
                    <div class="form-group row">
                        <label for="txt_GAmount" class="col-sm-4 col-form-label fw-bolder"><i
                                class="bi bi-currency-dollar"></i> Gross Total </label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control form-control-sm fw-bolder" id="txt_grossamount">
                        </div>
                    </div>

                </div>
            </div>
            <div class="row justify-content-end mt-4">
                <div class="col-md-2 m-1">
                    <div class="form-group row">
                        <button type="button" class="btn btn-danger" id="btn"><i class="bi bi-printer"></i>
                            Print</button>
                    </div>
                </div>
                <div class="col-md-2 m-1">
                    <div class="form-group row">
                        <button type="button" class="btn btn-dark" id="btn_submit" onclick="formSubmit()"><i
                                class="bi bi-save"></i> Submit</button>
                    </div>
                </div>
            </div>
    </div>



    <!-- Optional JavaScript; choose one of the two! -->

    <!-- Option 1: Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>

    <!-- Option 2: Separate Popper and Bootstrap JS -->

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"
        integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js"
        integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF"
        crossorigin="anonymous"></script>

</body>

</html>